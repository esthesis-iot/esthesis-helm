apiVersion: apisix.apache.org/v2
kind: ApisixRoute
metadata:
  name: srv-security-routes
spec:
  http:
    - name: srv-public-access-ingress-route
      match:
        paths:
          - /api/security
          - /api/security/*
      backends:
        - serviceName: {{ .Release.Name }}-srv-security-service
          servicePort: 8080
      plugins:
        - name: proxy-rewrite
          enable: true
          config:
              regex_uri:
                - "/api/security/(.*)"
                - "/api/$1"
        - name: openid-connect
          enable: true
          config:
            client_id: "esthesis"
            client_secret: ""
            discovery:
            scope: "openid profile"
            use_jwks: true
            bearer_only: true
            realm: "esthesis"
            redirect_uri: "/api/security/callback"
            set_access_token_header: false
            set_id_token_header: false
            set_userinfo_header:  false
